# feat(credentials): Pre-flight credential validation with actionable error messages

Resolves #4391

## Summary

When LLM provider credentials are missing or invalid, users previously saw cryptic, unhelpful errors like `completion() got unexpected keyword argument 'model'` that gave no indication of the root cause. This PR adds **pre-flight credential validation** with clear, actionable error messages and a new `hive doctor` diagnostic command.

## What Changed

### New Files

| File | Purpose |
|------|---------|
| `core/framework/credentials/validator.py` | Pre-flight credential validation with provider registry and rich error messages |
| `core/framework/cli/__init__.py` | CLI sub-package init |
| `core/framework/cli/doctor.py` | `hive doctor` diagnostic command |
| `core/tests/test_credential_validator.py` | 38 comprehensive unit tests |

### Modified Files

| File | Change |
|------|--------|
| `core/framework/llm/litellm.py` | Added pre-flight credential check in `__init__` (+15 lines) |
| `core/framework/llm/anthropic.py` | Replaced cryptic `ValueError` with actionable `CredentialError` (+19 lines) |
| `core/framework/cli.py` | Registered `hive doctor` command (+27 lines) |
| `core/framework/credentials/__init__.py` | Exported `CredentialValidator` and `CredentialIssue` (+4 lines) |

## Before vs After

### Before (cryptic):
```
$ hive run my_agent.py
Error: completion() got unexpected keyword argument 'model'
```

### After (actionable):
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âŒ Anthropic API Key Not Found
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

The Anthropic API requires an API key, but none was found.

ğŸ“ Missing: ANTHROPIC_API_KEY environment variable

ğŸ”§ How to Fix:

  1. Get your API key:
     ğŸ‘‰ https://console.anthropic.com/settings/keys

  2. Set the environment variable:
     export ANTHROPIC_API_KEY="your-api-key-here"

  3. Or add to config file:
     # ~/.hive/config.json

  4. Verify setup:
     hive doctor  # Run diagnostic check
```

## Key Design Decisions

1. **Warning-level in LiteLLMProvider**: The pre-flight check in `LiteLLMProvider.__init__` logs a warning instead of raising â€” this is because LiteLLM supports many providers and the key might be passed via other mechanisms. The explicit check in `AnthropicProvider` raises an error since there's no ambiguity.

2. **Provider registry**: Uses a data-driven approach (`_PROVIDER_REGISTRY`) mapping providers to their env vars, console URLs, key patterns, and config examples. Easy to extend for new providers.

3. **Model auto-detection**: `_MODEL_PROVIDER_MAP` maps model name prefixes to providers, enabling `validate_for_model("claude-3-haiku")` to automatically check `ANTHROPIC_API_KEY`.

4. **Graceful degradation**: All validator imports are wrapped in `try/except ImportError` so the system works even if the validator module isn't available.

5. **No breaking changes**: Only adds better error messages. All existing behavior is preserved.

## Supported Providers

| Provider | Env Var | Key Validation |
|----------|---------|----------------|
| Anthropic | `ANTHROPIC_API_KEY` | Prefix `sk-ant-` |
| OpenAI | `OPENAI_API_KEY` | Prefix `sk-` |
| Google Gemini | `GEMINI_API_KEY` | Prefix `AI` |
| Groq | `GROQ_API_KEY` | Prefix `gsk_` |
| Mistral | `MISTRAL_API_KEY` | Presence only |
| DeepSeek | `DEEPSEEK_API_KEY` | Presence only |

## Testing

38 unit tests covering:
- Missing credential detection (4 tests)
- Invalid key format detection (3 tests)
- Valid credential pass-through (4 tests)
- Model-to-provider mapping (14 tests)
- Multi-provider validation (3 tests)
- Error message formatting (6 tests)
- Exception conversion (2 tests)
- Multi-issue formatting (2 tests)

All tests pass: `38 passed in 2.80s`
